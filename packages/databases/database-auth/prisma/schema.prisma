generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  binaryTargets = ["native", "debian-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USUARIOS & AUTH ---

model User {
  id String @id @default(uuid())

  username String @unique
  email    String @unique
  password String

  name     String
  lastName String
  dni      String @unique

  isVerified Boolean @default(false)
  isActive   Boolean @default(true)

  isTwoFactorEnabled Boolean @default(false)
  twoFactorSecret    String?

  hashedRefreshToken String?

  isSuperAdmin Boolean  @default(false)
  memberships  Member[]

  logs Log[]

  // OAuth2 relations
  oauthTokens OAuthToken[]
  oauthCodes  OAuthAuthorizationCode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// --- PROYECTOS ---

model Project {
  id          String  @id @default(uuid())
  name        String
  description String?
  code        String  @unique
  isActive    Boolean @default(true)

  members Member[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

// --- ROLES & PERMISOS (RBAC) ---

model Member {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, projectId])
  @@map("members")
}

model Organization {
  id         String   @id
  name       String
  cuit       String?
  code       String   @unique
  externalId String?  @unique
  members    Member[]

  @@map("organizations")
}

model Role {
  id          String  @id @default(uuid())
  name        String
  code        String  @unique
  description String?

  permissions RolePermission[]
  members     Member[]

  @@unique([name])
  @@map("roles")
}

model Permission {
  id       String @id @default(uuid())
  resource String
  action   String
  code     String @unique

  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// --- AUDITOR√çA ---

model Log {
  id String @id @default(uuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action     String
  resource   String
  resourceId String?

  preMod  Json?
  postMod Json?
  meta    Json?

  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// --- OAUTH2 / OPENID CONNECT ---

model OAuthClient {
  id String @id @default(uuid())

  clientId     String   @unique
  clientSecret String
  name         String
  redirectUris String[] // Array de URIs permitidas para redirect
  grants       String[] // Ej: ["authorization_code", "refresh_token"]

  // Metadatos
  isActive Boolean @default(true)

  // Relaciones
  tokens OAuthToken[]
  codes  OAuthAuthorizationCode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("oauth_clients")
}

model OAuthAuthorizationCode {
  id String @id @default(uuid())

  code String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientId    String
  oauthClient OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  redirectUri String
  scopes      String[] // Ej: ["openid", "profile", "email"]

  expiresAt DateTime
  isUsed    Boolean  @default(false)

  createdAt DateTime @default(now())

  @@map("oauth_authorization_codes")
}

model OAuthToken {
  id String @id @default(uuid())

  accessToken  String  @unique
  refreshToken String? @unique
  tokenType    String  @default("Bearer")

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientId    String
  oauthClient OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  scopes String[] // Ej: ["openid", "profile", "email"]

  accessTokenExpiresAt  DateTime
  refreshTokenExpiresAt DateTime?

  isRevoked Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("oauth_tokens")
}
